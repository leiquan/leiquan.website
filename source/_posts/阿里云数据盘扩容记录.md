---
title: 阿里云数据盘扩容记录
date: 2018-10-28 02:56:00
category: 服务器
tags:
  - 服务器运维
---

环境：CentOS 7.3 x64

#### 为什么需要进行数据盘扩容呢？

由于我们的 cloud 和 git 的数据量越来越大，数据盘占用到了98%，因而需要立刻扩容。

本次扩容把数据盘的容量从20GB扩展到了30GB，本想扩大到更大的，但是更大不也就更贵的么，所以先加上10GB 再说，后续如果需要，可以再次扩容。


<!--more-->

#### 服务器操作记录如下：
  
##### 0.备份数据盘
在阿里云控制台的 ECS 下面找到本机磁盘，在数据盘实例下面，建立磁盘快照，进行数据备份。

##### 1.停止服务
查看/data 文件夹，发现跟本目录相关的服务有：
Apache，MongoDB，gogs

依次停止：
```bash
systemctl stop httpd

ps -ef | grep mongo
kill  2438

ps -ef | grep gogs
kill 2604
```


##### 2、卸载数据盘 
```bash
umount /data 
```

提示目标忙，我们看看为什么忙：
```bash
fuser -v /data
kill -9 6878
```

目标忙的真实原因是在终端打开了目录，因此退出后就不会忙了，可以直接 unmount

##### 3.查看是否卸载成功
```bash
df -hl
```

##### 4.删除原有分区并新建分区 
 
使用 fdisk 指令，输入 d 来删除原有的分区，然后依次输入 n，p，1 来新建分区 
```bash
 fdisk /dev/vdb
```
依次输入：
d
n
p
1
wq

##### 5、格式化磁盘
使用 resize2fs 指令扩大文件系统大小，原有数据不会丢失。 
```bash
e2fsck -f /dev/vdb
 
resize2fs /dev/vdb
```

###### 6.挂载磁盘
```bash
mount /dev/vdb /data 
```

##### 7.检查是否挂载成功
```bash
df -hl 
```

##### 8.恢复服务
```bash
systemctl start httpd

mongod --auth --bind_ip 0.0.0.0 --dbpath /data/mongo-data --fork --syslog 

su git
nohup /opt/gogs/gogs web &
su root
```